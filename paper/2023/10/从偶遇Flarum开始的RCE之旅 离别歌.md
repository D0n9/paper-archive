# ä»å¶é‡Flarumå¼€å§‹çš„RCEä¹‹æ—… | ç¦»åˆ«æ­Œ
> æœ¬æ–‡é¦–å‘äº[è·³è·³ç³–](https://tttang.com/archive/1714/)ï¼Œè½¬è½½è¯·è”ç³»ç«™æ–¹ã€‚  
> æœ¬æ¬¡æµ‹è¯•è¿‡ç¨‹å®Œå…¨å¤„äºæœ¬åœ°æˆ–æˆæƒç¯å¢ƒï¼Œä»…ä¾›å­¦ä¹ ä¸å‚è€ƒï¼Œä¸å­˜åœ¨æœªæˆæƒæµ‹è¯•è¿‡ç¨‹ï¼Œè¯·è¯»è€…å‹¿ä½¿ç”¨è¯¥æ¼æ´è¿›è¡Œæœªæˆæƒæµ‹è¯•ï¼Œå¦åˆ™ä½œè€…ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»

ä¸€æ¬¡æ—¥å¸¸æµ‹è¯•ä¸­ï¼Œå¶ç„¶é‡åˆ°äº†ä¸€ä¸ªFlarumæ­å»ºçš„è®ºå›ï¼Œå¹¶è·å¾—äº†å…¶ç®¡ç†å‘˜è´¦å·ã€‚æœ¬æ¥åˆ°è¿™é‡Œå·²ç»å¯ä»¥ç®—å®Œæˆäº†ä»»åŠ¡ï¼Œå°†æ¼æ´æŠ¥ç»™å…·ä½“è´Ÿè´£çš„äººå°±ç»“æŸäº†ï¼Œä½†æ˜¯æ—¢ç„¶å·²ç»æ‹¿åˆ°äº†ç®¡ç†å‘˜è´¦å·ï¼Œä½•ä¸å°è¯•ä¸€ä¸‹RCEå‘¢ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘åœ¨ç®¡ç†å‘˜åå°çœ‹åˆ°å½“å‰Flarumç‰ˆæœ¬æ˜¯1.3ï¼ŒPHPç‰ˆæœ¬æ˜¯7.4ã€‚Flarumä»¥å‰æ²¡æœ‰é‡åˆ°è¿‡ï¼Œäºæ˜¯é—®ä¸‹å¸ˆå‚…ä»¬æœ‰æ²¡æœ‰å†å²æ¼æ´ï¼Œæ²¡å‡†å°±ä¸ç”¨è´¹äº‹äº†ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/000a3240-6008-45a5-84a5-b9a65ccc41e3.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/5179d621-44ea-40b2-932a-539b75fbf05b.png)

ç»“æœæ˜¾ç„¶æ˜¯æ²¡æœ‰ï¼Œå¦åˆ™ä¹Ÿä¸ä¼šæœ‰è¿™ç¯‡æ–‡ç« äº†ğŸ˜‚ã€‚

[Flarum](https://github.com/flarum/flarum)æ˜¯ä¸€ä¸ªPHPå¼€æºçš„è®ºå›ç¤¾åŒºç³»ç»Ÿï¼Œä»¥å‰æœ‰å¬è¯´è¿‡ï¼Œä¸»è¦æ˜¯å›½å¤–ç”¨æˆ·è¾ƒå¤šï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ˜¯å‡ºå›½ä»¥åæ‰é‡åˆ°ã€‚ç®€å•æœäº†ä¸‹ç½‘ä¸Šå…¬å¼€çš„æ¼æ´ï¼Œç¡®å®å¾ˆå°‘ï¼Œè€Œä¸”ä»¥XSSå’Œè¶Šæƒä¸ºä¸»ã€‚

æˆ‘å¯¹å‰åå°è¿›è¡Œäº†ä¸€ç³»åˆ—è§‚å¯Ÿï¼Œå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªè®ºå›CMSé»˜è®¤çš„åŠŸèƒ½è¾ƒå°‘ï¼Œå¤§éƒ¨åˆ†æ‰©å±•æ€§ç”±æ’ä»¶å®ç°ï¼Œä½†å®‰è£…æ’ä»¶å´åªèƒ½é€šè¿‡å‘½ä»¤è¡Œcomposerã€‚æµè§ˆäº†ä¸€éåå°æ‰€æœ‰çš„åŠŸèƒ½ï¼ŒåŸºæœ¬éƒ½æ˜¯é’ˆå¯¹å¸–å­å’Œç”¨æˆ·è¿›è¡Œç®¡ç†çš„ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/8474bcd6-1aad-4e03-9952-af0fbee3cedc.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/9abe5d85-0812-4237-9989-52dd93fd8687.png)

é»‘ç›’æ²¡æœ‰è¿›å±•ï¼Œé‚£ä¹ˆä¸‹è½½æºç è¿›è¡Œä»£ç å®¡è®¡å§ã€‚

[0x01 ä»£ç é€šè¯»ä¸é€»è¾‘æ¢³ç†](#0x01)
-----------------------

æœ¬åœ°å®‰è£…å¥½Flarumï¼Œå‘ç°åªæœ‰ä¸‰ä¸ªç›®å½•ï¼š

*   publicï¼šWebæ ¹ç›®å½•ï¼Œé‡Œé¢åªæœ‰index.php
*   storageï¼šå‚¨å­˜runtimeæ–‡ä»¶çš„ç›®å½•ï¼Œé‡Œé¢æœ‰sessionã€cacheã€logsç­‰
*   vendorï¼šåº“æ–‡ä»¶ç›®å½•ï¼Œä½¿ç”¨composerå®‰è£…

æ‰€æœ‰ä»£ç éƒ½åœ¨vendorä¸­ã€‚å®ƒä½¿ç”¨äº†å¾ˆå¤šLaravelå’ŒLaminasæ¡†æ¶çš„componentsï¼Œä½†ä¸»ä½“çš„MVCæ¶æ„æ˜¯è‡ªå·±å®ç°çš„ï¼Œå¹¶å¤§é‡ä½¿ç”¨äº†ä¾èµ–æ³¨å…¥å’Œäº‹ä»¶æœºåˆ¶ï¼ˆè¿™ä¸€ç‚¹å’Œæˆ‘ä¹‹å‰åˆ†æçš„[Cachet](https://www.leavesongs.com/PENETRATION/cachet-from-laravel-sqli-to-bug-bounty.html)æœ‰ç‚¹åƒï¼Œä½†Cachetæ˜¯ä½¿ç”¨çš„æ ‡å‡†Laravelç»“æ„ï¼Œæ›´ç®€å•ä¸€äº›ï¼‰ï¼Œå¯¼è‡´æˆ‘ç†Ÿæ‚‰ç›®å½•æ–‡ä»¶ç»“æ„å’Œæ•°æ®æµè½¬æ–¹å¼å°±èŠ±äº†å¾ˆé•¿æ—¶é—´ã€‚

æˆ‘ä»¬å¯ä»¥é˜…è¯»Flarumçš„[æ‰©å±•å¼€å‘æ–‡æ¡£](https://docs.flarum.org/extend)ï¼Œæ¥è¿›ä¸€æ­¥äº†è§£æ•´ä¸ªé¡¹ç›®çš„æ¶æ„ä¸å„ä¸ªéƒ¨åˆ†çš„ä½¿ç”¨æ–¹æ³•ã€‚

ç°ä»£PHPé¡¹ç›®æƒ³è¦getshellï¼Œå¸¸è§çš„è·¯å¾„æœ‰ä¸‹é¢å‡ ä¸ªï¼š

*   æ–‡ä»¶ä¸Šä¼ æ¼æ´
*   è·¯ç”±é”™è¯¯å¯¼è‡´çš„å‡½æ•°æ‰§è¡Œæ¼æ´ï¼Œæ¯”å¦‚ThinkPHP 5çš„ä¸¤ä¸ªRCE
*   æ¨¡æ¿æ³¨å…¥æ¼æ´ï¼Œæ¯”å¦‚Cachetè¿™ä¸ª[åå°getshell](https://www.leavesongs.com/PENETRATION/cachet-from-laravel-sqli-to-bug-bounty.html)
*   ååºåˆ—åŒ–æ¼æ´

æ–‡ä»¶ä¸Šä¼ æ¼æ´æ˜¯ä¼ ç»Ÿæ¼æ´äº†ï¼Œä½†å¦‚æœè§„èŒƒä½¿ç”¨Webæ¡†æ¶æ˜¯ä¸å¤ªä¼šå‡ºç°çš„ï¼Œç‰¹åˆ«æ˜¯ç°ä»£çš„Laravelç­‰æ¡†æ¶ï¼›è·¯ç”±é”™è¯¯å¯¼è‡´çš„å‡½æ•°æ‰§è¡Œæ¼æ´å¤šå‡ºç°äºä¸Šä¸€ä»£çš„MVCæ¡†æ¶ï¼Œè¿™ç±»æ¡†æ¶ä¼šå°†ç”¨æˆ·è¾“å…¥è§£ææˆclass nameå’Œmethod nameå†åŠ¨æ€è°ƒç”¨ï¼Œè€Œç°åœ¨çš„æ¡†æ¶è·¯ç”±å¤šæ˜¯å®šä¹‰ä¸€ä¸ªå®Œæ•´çš„è·¯ç”±ï¼ŒFlarumä¹Ÿæ˜¯è¿™æ ·ï¼›æ¨¡æ¿æ³¨å…¥æ¼æ´åœ¨åå°åŠŸèƒ½ä¸­ç›¸å¯¹è¾ƒå¤šï¼Œæœ‰æ—¶å€™ç”šè‡³ç›´æ¥å°±æ˜¯PHPä»£ç ï¼ˆWordpressï¼‰ï¼›ååºåˆ—åŒ–æ¼æ´å¤šå‡ºç°åœ¨æ•°æ®åº“ã€sessionã€ç¼“å­˜ä¹‹ç±»çš„ä½ç½®ï¼Œå¦‚æœèƒ½æ§åˆ¶è¿™äº›åœ°æ–¹ï¼Œå¯ä»¥ç€é‡æ‰¾è¿™ç›¸å…³çš„åŠŸèƒ½ã€‚

æˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªæ€è·¯é€ä¸€è¿›è¡Œæµ‹è¯•ã€‚

### [æ–‡ä»¶ä¸Šä¼ ](#_1)

é¦–å…ˆæ˜¯æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ŒFlarumä»…æœ‰ä¸‰å¤„æ”¯æŒæ–‡ä»¶ä¸Šä¼ çš„é€»è¾‘ï¼Œåˆ†åˆ«æ˜¯ç½‘ç«™Logoã€Faviconå’Œç”¨æˆ·å¤´åƒâ€¦â€¦æ˜¯çš„ï¼Œä½œä¸ºä¸€ä¸ªè®ºå›ç¤¾åŒºï¼Œå‘å¸–é»˜è®¤ä¸æ”¯æŒä¸Šä¼ é™„ä»¶å’Œå›¾ç‰‡ï¼Œéœ€è¦å®‰è£…æ‰©å±•æ¥å®ç°ï¼Œè€Œæˆ‘ä»¬çš„ç›®æ ‡å¹¶æ²¡æœ‰è¿™ç±»æ‰©å±•ã€‚

çœ‹äº†ä¸€ä¸‹ä¸‰å¤„å›¾ç‰‡ä¸Šä¼ çš„ä»£ç ï¼Œæ–‡ä»¶åæ— æ³•æ§åˆ¶ï¼Œåç¼€å†™æ­»æˆ.pngï¼Œæ–‡ä»¶å†…å®¹ä¹Ÿä¼šä½¿ç”¨GDåº“è½¬æ¢æˆpngæ ¼å¼ä¿å­˜ï¼Œå¯è°“æ˜¯æ°´æ³„ä¸é€šäº†ã€‚æ¯”å¦‚è¿™æ˜¯ä¸Šä¼ ç”¨æˆ·å¤´åƒçš„éƒ¨åˆ†ä»£ç ï¼š

`/**
 * @param User $user
 * @param Image $image
 */
public function upload(User $user, Image $image)
{
    if (extension_loaded('exif')) {
        $image->orientate();
    }

    $encodedImage = $image->fit(100, 100)->encode('png');

    $avatarPath = Str::random().'.png';

    $this->removeFileAfterSave($user);
    $user->changeAvatarPath($avatarPath);

    $this->uploadDir->put($avatarPath, $encodedImage);
}` 

è¿™æ¡è·¯å µæ­»ï¼Œç”šè‡³ç»™æˆ‘åé¢çš„æ¼æ´åˆ©ç”¨ä¹Ÿé€ æˆäº†å¾ˆå¤§å›°æ‰°ã€‚

### [è·¯ç”±é—®é¢˜](#_2)

Flarumæ²¡æœ‰åŠ¨æ€æ‰§è¡Œç”¨æˆ·ä¼ å…¥çš„ç±»å’Œå‡½æ•°ï¼Œè€Œæ˜¯é€šè¿‡routerçš„æ–¹å¼åˆ†å‘è·¯ç”±ï¼Œæ¯”å¦‚ï¼š

`return function (RouteCollection $map, RouteHandlerFactory $route) {
    // Get forum information
    $map->get(
        '/',
        'forum.show',
        $route->toController(Controller\ShowForumController::class)
    );

    //...
}` 

æ‰€ä»¥æˆ‘åˆ¤æ–­è·¯ç”±å‡ºé—®é¢˜çš„å¯èƒ½æ€§è¾ƒå°ï¼Œå°±æ²¡æœ‰ç»†çœ‹ã€‚

### [æ¨¡æ¿æ³¨å…¥æ¼æ´](#_3)

æˆ‘ç¿»äº†åå°é¡µé¢ï¼Œå¹¶æ²¡æœ‰å‘ç°å­˜åœ¨ä»»ä½•æœ‰å…³ç¼–è¾‘æ¨¡æ¿çš„åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™æ¡è·¯ä¹Ÿä½œç½¢ã€‚

### [ååºåˆ—åŒ–æ¼æ´](#_4)

ç»è¿‡åˆ†æï¼ŒFlarumä¸­å­˜åœ¨ååºåˆ—åŒ–çš„æœ‰ä¸¤ä¸ªåœ°æ–¹ï¼Œä¸€æ˜¯sessionï¼ŒäºŒæ˜¯ç¼“å­˜ï¼Œä½†è¿™ä¸¤ä¸ªéƒ½å‚¨å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œè€Œæˆ‘ä»¬å¹¶ä¸èƒ½æ§åˆ¶æ–‡ä»¶å†…å®¹ã€‚

ç»ˆä¸Šæ‰€è¿°ï¼Œç»è¿‡å‰é¢çš„åˆ†æï¼Œå·²ç»å¤§è‡´æ’é™¤äº†ä¸€äº›å¸¸è§çš„å¯èƒ½å¯¼è‡´RCEæ¼æ´çš„ç‚¹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å¦‚ä½•æ·±å…¥å‘¢ï¼Ÿ

[0x02 åˆ©ç”¨CSSæ¸²æŸ“è¯»å–ä»»æ„æ–‡ä»¶](#0x02-css)
-------------------------------

è¿™æ˜¯æˆ‘ç¬¬ä¸€æ¬¡è¢«å¡ä½ï¼Œä½†å¾ˆå¿«æˆ‘çœ‹åˆ°äº†åå°çš„ä¸€ä¸ªåŠŸèƒ½ï¼š**è‡ªå®šä¹‰CSSæ ·å¼**ã€‚

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/75b188c3-ef7b-4fa7-83f0-27767fe1d44f.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/3daf9482-401f-4623-bb41-3bdcd596bbf8.png)

å¾ˆå¤šCMSéƒ½æœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†Flarumæœ‰ä¸ªæœ‰è¶£çš„åœ°æ–¹æ˜¯å…¶æ”¯æŒLessè¯­æ³•ã€‚

[Less](https://lesscss.org/)æ˜¯ä¸€ä¸ªå®Œå…¨å…¼å®¹CSSçš„è¯­è¨€ï¼Œå¹¶åœ¨CSSçš„åŸºç¡€ä¸Šæä¾›äº†å¾ˆå¤šé«˜çº§è¯­æ³•ä¸åŠŸèƒ½ï¼Œæ¯”å¦‚CSSä¸­ä¸æ”¯æŒçš„æ¡ä»¶åˆ¤æ–­ä¸å¾ªç¯ï¼Œç›¸å½“äºæ˜¯CSSè¯­è¨€çš„è¶…é›†ã€‚å‰ç«¯å¼€å‘è€…ä½¿ç”¨Lessç¼–å†™çš„ç¨‹åºï¼Œå¯ä»¥é€šè¿‡ç¼–è¯‘å™¨è½¬æ¢æˆåˆæ³•çš„CSSè¯­æ³•ï¼Œæä¾›ç»™æµè§ˆå™¨è¿›è¡Œæ¸²æŸ“ã€‚

é‚£ä¹ˆå°±æœ‰è¶£äº†ï¼Œè¿™é‡Œæ”¯æŒLessè¯­æ³•ï¼Œè¯´æ˜è¿™å…¶ä¸­å­˜åœ¨ä»£ç ç¼–è¯‘çš„è¿‡ç¨‹ï¼Œè¿™è®©æˆ‘æœ‰ä¸¤ä¸ªæ€è·¯ï¼š

*   ç¼–è¯‘è¿‡ç¨‹æœ¬èº«æ˜¯å¦å­˜åœ¨æ¼æ´ï¼Œå¯ä»¥ç”¨äºæ‰§è¡Œä»»æ„ä»£ç æˆ–å‘½ä»¤
*   Lessè¯­è¨€ä¸­æ˜¯å¦æœ‰ä¸€äº›é«˜å±çš„å‡½æ•°ï¼Œå¯ä»¥æ‰§è¡Œä»£ç æˆ–å‘½ä»¤

Flarumä½¿ç”¨äº†[less.php](https://github.com/wikimedia/less.php)è¿™ä¸ªç¬¬ä¸‰æ–¹åº“æ¥ç¼–è¯‘Lessï¼Œæˆ‘ä»¬åœ¨å…¶READMEé¡µé¢å¾ˆå®¹æ˜“çœ‹åˆ°ä¸‹é¢è¿™æ®µè­¦å‘Šï¼š

> **âš ï¸ Security**
> 
> The LESS processor language is powerful and including features that can read or embed arbitrary files that the web server has access to, and features that may be computationally exensive if misused.
> 
> In general you should treat LESS files as being in the same trust domain as other server-side executables, such as Node.js or PHP code. In particular, it is not recommended to allow people that use your web service to provide arbitrary LESS code for server-side processing.

çœ‹èµ·æ¥less.phpè‡ªå·±ä¹ŸçŸ¥é“åœ¨æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›å®‰å…¨éšæ‚£ã€‚

æˆ‘å¾ˆå¿«åœ¨Lessè¯­è¨€çš„[æ–‡æ¡£](https://lesscss.org/functions/#misc-functions-data-uri)ä¸­æ‰¾åˆ°äº†è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼šdata-uri

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/2a53e7b1-1c0f-4e7f-b2c0-c8cb8c58ad91.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/51e102ed-fa85-466f-a312-df74c25225ff.png)

åœ¨Lessä¸­ï¼Œdata-uriå‡½æ•°ç”¨äºè¯»å–æ–‡ä»¶å¹¶è½¬æ¢æˆdataåè®®è¾“å‡ºåœ¨cssä¸­ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹less.phpä¸­ç›¸å…³çš„å®ç°ï¼š

`public function datauri( $mimetypeNode, $filePathNode = null ) {
    $filePath = ( $filePathNode ? $filePathNode->value : null );
    // ...

    if ( file_exists( $filePath ) ) {
        $buf = @file_get_contents( $filePath );
    } else {
        $buf = false;
    }
    // ...
}` 

ä¸€ä¸ªå¯ä»¥æ§åˆ¶å®Œæ•´è·¯å¾„çš„æ–‡ä»¶è¯»å–æ¼æ´ï¼

æˆ‘ä»¬å°è¯•åœ¨åå°ä¿®æ”¹CSSï¼Œå†™å…¥æˆ‘ä»¬çš„Payloadï¼š

`.test  {
  content:  data-uri('/etc/passwd');
}` 

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/f4918d61-979e-42d0-8807-ed8ef71c35cc.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/24e0657a-bcd9-415d-9051-c2d1e3383b9b.png)

ç„¶åï¼Œåœ¨é¡µé¢æºç ä¸­æ‰¾åˆ°CSSçš„åœ°å€ï¼Œæœç´¢ä¸€ä¸‹`.test`è¿™ä¸ªæ ·å¼ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/587b0e9e-4fce-4b3f-8d40-39d77dc25452.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/cbfd1d8d-8448-49fc-b810-8cf07e81521b.png)

å¯¹å…¶ä¸­çš„base64è¿›è¡Œè§£ç ï¼ŒæˆåŠŸè¯»å–åˆ°`/etc/passwd`ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/233faa9b-06b4-4ada-8265-f797114d6cb6.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/f0d03d97-74df-4913-bf28-3725ed05942b.png)

OKï¼Œæˆ‘ä»¬ç°åœ¨æœ‰äº†ä¸€ä¸ªä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ã€‚

[0x03 phar://ååºåˆ—åŒ–å°è¯•](#0x03-phar)
--------------------------------

é€šè¿‡å¯¹åˆšæ‰ä»£ç çš„åˆ†æå°±å¯ä»¥å‘ç°ï¼Œ`file_exists`å’Œ`file_get_contents`çš„å®Œæ•´è·¯å¾„å¯ä»¥è¢«æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå¯ä»¥ä½¿ç”¨ä»»æ„åè®®ã€‚å¹¸è¿çš„æ˜¯ï¼Œç›®æ ‡ç³»ç»Ÿæ˜¯PHP 7.4ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ä½¿ç”¨phar://æ¥æ„é€ ååºåˆ—åŒ–ï¼Œç›¸æ¯”èµ·æ¥ï¼ŒPHP 8.0ä»¥ä¸Šå°±ä¸å†æ”¯æŒpharååºåˆ—åŒ–äº†ã€‚

å…³äºphar://ååºåˆ—åŒ–ï¼Œå¯ä»¥å‚è€ƒBlackhat 2018çš„è¿™ä¸ªè®®é¢˜ã€Š[Itâ€™s a PHP unserialization vulnerability Jim, but not as we know it](https://i.blackhat.com/us-18/Thu-August-9/us-18-Thomas-Its-A-PHP-Unserialization-Vulnerability-Jim-But-Not-As-We-Know-It.pdf)ã€‹ã€‚

pharæ˜¯PHPä¸­ç±»ä¼¼äºJarçš„åŒ…æ ¼å¼ï¼Œè€Œå…¶ä¸­ä¿å­˜çš„metadataä¿¡æ¯åœ¨è¯»å–çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨ååºåˆ—åŒ–ã€‚è¿™æ ·ï¼Œå¦‚æœæ”»å‡»è€…å¯ä»¥æ§åˆ¶æ–‡ä»¶æ“ä½œçš„å®Œæ•´è·¯å¾„ï¼Œå¹¶èƒ½å¤Ÿåœ¨æœåŠ¡å™¨ä¸Šä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œå°†å¯ä»¥åˆ©ç”¨phar://åè®®æŒ‡å‘è¿™ä¸ªæ–‡ä»¶è¿›è€Œæ‰§è¡Œååºåˆ—åŒ–æ“ä½œã€‚

æˆ‘ä»¬ç°åœ¨æ»¡è¶³äº†ä¸€ä¸ªæ¡ä»¶ï¼Œè¿˜éœ€è¦æ‰¾ä¸€ä¸ªæœåŠ¡å™¨ä¸Šå¯æ§å†…å®¹çš„æ–‡ä»¶ï¼ˆä¸éœ€è¦æ§åˆ¶æ–‡ä»¶åæˆ–åç¼€ï¼‰ã€‚è¿™ä¸ªé—®é¢˜æœ‰ç‚¹åƒæˆ‘[è¿™ç¯‡æ–‡ç« ](https://www.leavesongs.com/PENETRATION/docker-php-include-getshell.html)é‡Œä»‹ç»çš„â€œè£¸æ–‡ä»¶åŒ…å«â€ï¼Œä½†åˆä¸å®Œå…¨ä¸€æ ·ï¼Œpharååºåˆ—åŒ–å¯¹æ–‡ä»¶å†…å®¹çš„è¦æ±‚ç›¸æ¯”èµ·æ¥ä¼šæ›´åŠ è‹›åˆ»ã€‚

å¯¹äºæ–‡ä»¶åŒ…å«æ¼æ´æ¥è®²ï¼Œæˆ‘ä»¬åªéœ€è¦æ§åˆ¶ä»»æ„ä¸€ä¸ªæ–‡ä»¶ä¸­çš„ä¸€éƒ¨åˆ†å³å¯ï¼Œå¯¹äºæ–‡ä»¶æ ¼å¼ã€æ˜¯å¦æœ‰è„å­—ç¬¦ç­‰æ²¡æœ‰è¦æ±‚ï¼›è€Œpharååºåˆ—åŒ–åœºæ™¯ä¸‹ï¼Œéœ€è¦è¿™ä¸ªæ–‡ä»¶å†…å®¹æ»¡è¶³ä¸€å®šçš„æ ¼å¼æ‰èƒ½æˆåŠŸè¢«åŠ è½½ï¼Œè¿›è¡Œååºåˆ—åŒ–ã€‚

pharæ–‡ä»¶å¯ä»¥æ˜¯ä¸‹é¢ä¸‰ç§æ ¼å¼ï¼š

*   zip
*   tar
*   phar

è¿™ä¸‰è€…éƒ½æ˜¯archiveæ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[phpgcc](https://github.com/ambionics/phpggc)è¿™æ¬¾å·¥å…·æ¥ç”Ÿæˆä¸€ä¸ªpharæ–‡ä»¶ï¼Œå¹¶å°†ååºåˆ—åŒ–åˆ©ç”¨é“¾æ’å…¥å…¶ä¸­ï¼š

`php phpggc -o evil.phar Monolog/RCE6 system id` 

å› ä¸ºFlarumä½¿ç”¨äº†monologï¼Œæˆ‘é€‰æ‹©äº†Monolog/RCE6è¿™æ¡åˆ©ç”¨é“¾ï¼Œæœ¬åœ°æµ‹è¯•å¯ä»¥æ­£å¸¸è§¦å‘ååºåˆ—åŒ–æ‰§è¡Œå‘½ä»¤ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/c105e589-82a2-4878-b0fd-a79fdef66cbd.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/b3da9ba1-a502-43f0-a863-c563aaef1efe.png)

ä½†æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªpharæ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šæ‰èƒ½åˆ©ç”¨ï¼Œè¿™è¦å¦‚ä½•åŠåˆ°å‘¢ï¼Ÿ

Flarumå‰é¢åˆ†æè¿‡ï¼Œå­˜åœ¨ä¸‰å¤„å›¾ç‰‡ä¸Šä¼ çš„åŠŸèƒ½ï¼Œè€Œpharæ˜¯å¯ä»¥ä¼ªé€ æˆå›¾ç‰‡æ–‡ä»¶æ ¼å¼çš„ï¼Œphpggcä¹Ÿè´´å¿ƒåœ°æä¾›äº†è¿™ä¸ªåŠŸèƒ½ï¼Œ`-pj`å‚æ•°ï¼š

`php phpggc -pj example.jpg -o evil.jpg Monolog/RCE6 system whoami` 

ä½¿ç”¨è¯¥å‚æ•°å³å¯å°†pharæ–‡ä»¶å’Œexample.jpgå›¾ç‰‡åˆ¶ä½œæˆä¸€ä¸ªâ€œå›¾ç‰‡é©¬â€ï¼Œåœ¨ä¸Šä¼ æ—¶å¯ä»¥è¢«è¯†åˆ«æˆå›¾ç‰‡ï¼Œä½†ä½¿ç”¨PHPè§£ææ—¶åˆå¯ä»¥è¯†åˆ«æˆpharæ–‡ä»¶ã€‚

äºæ˜¯æˆ‘å°è¯•å°†payloadä½¿ç”¨ä¸Šé¢çš„ä¸‰ä¸ªæ¥å£ä¸Šä¼ ï¼Œä½†è¯•äº†å¾ˆå¤šæ¬¡æ‰æƒ³èµ·äº†ä¹‹å‰é‚£æ®µä»£ç ï¼š

`$encodedImage = $image->fit(100, 100)->encode('png');` 

å¯„äº†ï¼Œè¿™ä¸‰ä¸ªæ¥å£éƒ½ä½¿ç”¨GDåº“è°ƒæ•´äº†å›¾ç‰‡å¤§å°ï¼Œå›¾ç‰‡ä¸€å¤„ç†å°±ä¼šæŠŠå…¶ä¸­é™„å¸¦çš„pharå†…å®¹ç»™å»æ‰ã€‚è™½ç„¶ä¹‹å‰æœ‰è¿‡é€šè¿‡GDåº“å¤„ç†ä¿ç•™Webshellçš„å›¾ç‰‡é©¬æ„é€ æ–¹æ³•ï¼Œä½†é‚£ä¸ªæ–¹æ³•ä»…é™äºä¿ç•™Webshellè¿™æ ·çš„ä»£ç ç‰‡æ®µï¼Œå¯¹äºpharè¿™ç§æ–‡ä»¶æ ¼å¼å´æ— èƒ½ä¸ºåŠ›ã€‚

é‚£ä¹ˆæ˜¯å¦è¿˜æœ‰å…¶ä»–æ–¹æ³•å¯ä»¥ä¸Šä¼ æ¶æ„pharæ–‡ä»¶å‘¢ï¼Ÿ

[0x04 æ¶æ„pharæ–‡ä»¶çš„æ„é€ ä¸å†™å…¥](#0x04-phar)
---------------------------------

è¿™æ˜¯ç¬¬äºŒæ¬¡å¡äº†æˆ‘å¾ˆä¹…çš„ç‚¹ï¼Œä¸€ç›´æ„Ÿè§‰ç¦»RCEåªå·®ä¸€å±‚çª—æˆ·çº¸ï¼Œä½†å¾ˆå¤šæ—¶å€™å°±æ˜¯è¢«ä¸€å±‚çª—æˆ·çº¸ç»™å½»åº•å µæ­»äº†æ‰€æœ‰è·¯ã€‚

æ˜¯å¦å¯ä»¥åˆ©ç”¨Sessionæˆ–PHPã€Nginxçš„ä¸´æ—¶æ–‡ä»¶å‘¢ï¼Ÿè¿™äº›æ–¹æ³•è¦ä¸å°±æ˜¯å¯¹ç¯å¢ƒæœ‰è¦æ±‚ï¼Œè¦ä¸å°±æ˜¯éœ€è¦æ¡ä»¶ç«äº‰ï¼Œéƒ½ä¸ç®—ç†æƒ³çš„åˆ©ç”¨æ–¹å¼ï¼Œæˆ‘å°†å…¶å°è¯•çš„ä¼˜å…ˆçº§é™åˆ°å¾ˆä½ï¼Œåªæœ‰åœ¨å½»åº•æ— æœ›çš„æƒ…å†µä¸‹æ‰ä¼šå»è€ƒè™‘ã€‚

å»å†°ç®±é‡Œæ‹¿å‡ºvidaæ°”æ³¡æ°´å–ä¸€å£ï¼Œæ€è€ƒä¸€ä¸‹æˆ‘è¿™ä¸€æ­¥çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼š**æˆ‘éœ€è¦æ§åˆ¶ä¸€ä¸ªæœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œå†™å…¥æˆ‘éœ€è¦çš„Payloadï¼Œè€Œä¸”çŸ¥é“æ–‡ä»¶åï¼Œä½†å¯¹æ–‡ä»¶åå’Œåç¼€æ²¡æœ‰è¦æ±‚ã€‚** 

è¿™æ—¶å€™æˆ‘æƒ³åˆ°ï¼Œå‰é¢è¿›è¡Œä»£ç å®¡è®¡çš„æ—¶å€™æˆ‘é˜…è¯»äº†Lessç”ŸæˆCSSçš„è¿‡ç¨‹ï¼Œå‘ç°ç®¡ç†å‘˜åœ¨åå°è¾“å…¥è‡ªå®šä¹‰CSSä»£ç çš„æ—¶å€™å°†ä¼šæŠŠæ¸²æŸ“å®Œæˆåçš„CSSæ–‡ä»¶å†™å…¥Webç›®å½•çš„assets/forum.cssæ–‡ä»¶ä¸­ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/65448940-93f9-463f-b311-6ebe5847e3b1.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/609a4c65-b6d0-4e8a-bff1-4a51711ae79c.png)

è¿™æ ·èƒ½æ»¡è¶³äº†æˆ‘çš„è¦æ±‚å—ï¼Ÿå¥½åƒè¿˜å·®ä¸€ç‚¹ï¼Œå› ä¸ºå®é™…æ€è€ƒä¸‹æ¥ï¼Œæˆ‘é‡åˆ°äº†ä¸¤ä¸ªéš¾ç‚¹ï¼š

*   ç”¨æˆ·è‡ªå®šä¹‰CSSä¼šè¢«æ’å…¥åˆ°å…¶ä»–å†…ç½®Lessè„šæœ¬ä¸­é—´ï¼Œå¯¼è‡´ç¼–è¯‘å‡ºçš„ä»£ç å‰åè¿˜ä¼šæœ‰ä¸å¯æ§çš„å…¶ä»–å­—ç¬¦ï¼ˆå¦‚ä¸Šå›¾ï¼‰
*   ç”¨æˆ·è¾“å…¥çš„å†…å®¹ä¼šå…ˆæ ¡éªŒæ˜¯å¦æ»¡è¶³Lessæˆ–CSSçš„æ ¼å¼ï¼Œå®Œæˆåæ‰ä¼šè¢«ç¼–è¯‘æˆforum.cssï¼Œä¸”ç¼–è¯‘è¿‡ç¨‹å¯èƒ½å¯¼è‡´å­—ç¬¦å˜åŒ–ç ´åpharæ–‡ä»¶æ ¼å¼ç»“æ„

ç¬¬ä¸€ç‚¹ï¼Œç»è¿‡åˆ†æå‘ç°ï¼ŒFlarumç”Ÿæˆçš„CSSæ˜¯åˆ†æˆä¸‰éƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯å†…ç½®CSSã€ç”¨æˆ·è‡ªå®šä¹‰CSSã€æ‰©å±•æ’ä»¶ä¸­å¸¦çš„CSSï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/5685b160-3fe5-4ce4-a4df-8a6e2f51c362.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/cd05f120-a67e-4d0b-b59e-c7fc49012acb.png)

ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶å†…ç½®CSSæˆ‘æ˜¯å®Œå…¨æ— æ³•æ§åˆ¶çš„ï¼Œä½†æˆ‘å¯ä»¥é€šè¿‡å°†æ‰€æœ‰æ‰©å±•éƒ½ç¦ç”¨æ¥å»é™¤ç¬¬ä¸‰éƒ¨åˆ†CSSã€‚

ç¦ç”¨æ‰€æœ‰æ‰©å±•ä»¥åï¼Œç”¨æˆ·è¾“å…¥çš„CSSå°±è¾“å‡ºåœ¨æ–‡ä»¶æœ«å°¾äº†ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/44ed156d-1f64-4d72-bd8f-f833f436b4b6.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/ee80ae54-8ece-47c3-8314-eea2c1ce2df1.png)

ä¸ºä»€ä¹ˆæˆ‘éœ€è¦ç ”ç©¶ç”¨æˆ·è‡ªå®šä¹‰å†…å®¹çš„è¾“å‡ºä½ç½®å‘¢ï¼Ÿå› ä¸ºPHPåœ¨è§£æpharçš„æ—¶å€™æ”¯æŒä¸‰ç§æ–‡ä»¶æ ¼å¼ï¼Œåˆ†åˆ«æ˜¯zipã€tarå’Œpharï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“æ˜¯å¦å¯æ§æ–‡ä»¶å¤´å’Œæ–‡ä»¶å°¾ï¼Œæ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥æ„é€ å‡ºæ»¡è¶³è¿™ä¸‰ç§æ ¼å¼çš„æ¶æ„æ–‡ä»¶ã€‚

**å¯¹äºzipæ ¼å¼**ï¼Œæˆ‘æ›¾åœ¨[çŸ¥è¯†æ˜Ÿçƒé‡Œ](https://t.zsxq.com/05aQbEY7Y)ä»‹ç»è¿‡ï¼Œå®ƒçš„æ–‡ä»¶å¤´å°¾éƒ½å¯ä»¥æœ‰è„å­—ç¬¦ï¼Œæˆ‘ä»¬å¯¹åç§»é‡è¿›è¡Œä¿®å¤å°±å¯ä»¥é‡æ–°è·å¾—ä¸€ä¸ªåˆæ³•çš„zipæ–‡ä»¶ã€‚ä½†æ˜¯å¦éµå®ˆè¿™ä¸ªè§„åˆ™ï¼Œä»ç„¶å–å†³äºzipè§£æå™¨ï¼Œç»è¿‡æµ‹è¯•ï¼Œpharè§£æå™¨å¦‚æœå‘ç°æ–‡ä»¶å¤´ä¸æ˜¯zipæ ¼å¼ï¼Œå³ä½¿åé¢åç§»é‡ä¿®å¤å®Œæˆï¼Œä¹Ÿå°†è§¦å‘é”™è¯¯ï¼š

> internal corruption of phar (truncated manifest header)

å½“ç„¶ï¼Œè¿™ä¹Ÿå¯èƒ½æ˜¯æˆ‘ä¿®å¤åç§»æ–¹å¼æœ‰é”™è¯¯ï¼Œå¯ä»¥åé¢å†æ·±å…¥ç ”ç©¶ï¼Œæš‚æ—¶è®¤ä¸ºzipæ ¼å¼æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ã€‚

**å¯¹äºtaræ ¼å¼**ï¼Œå¦‚æœæˆ‘ä»¬èƒ½æ§åˆ¶æ–‡ä»¶å¤´ï¼Œå³å¯æ„é€ åˆæ³•çš„taræ–‡ä»¶ï¼Œå³ä½¿æ–‡ä»¶å°¾æœ‰åƒåœ¾å­—ç¬¦ã€‚

**å¯¹äºpharæ ¼å¼**ï¼Œæˆ‘ä»¬å¿…é¡»æ§åˆ¶æ–‡ä»¶å°¾ï¼Œä½†ä¸éœ€è¦æ§åˆ¶æ–‡ä»¶å¤´ã€‚PHPåœ¨è§£ææ—¶ä¼šåœ¨æ–‡ä»¶å†…æŸ¥æ‰¾`<?php __HALT_COMPILER(); ?>`è¿™ä¸ªæ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾å‰é¢çš„å†…å®¹å¯ä»¥ä¸ºä»»æ„å€¼ï¼Œä½†åé¢çš„å†…å®¹å¿…é¡»æ˜¯pharæ ¼å¼ï¼Œå¹¶ä»¥è¯¥æ–‡ä»¶çš„sha1ç­¾åä¸å­—ç¬¦ä¸²`GBMB`ç»“å°¾ã€‚

å¯è§ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥æ§åˆ¶æ–‡ä»¶å°¾ï¼Œæˆ‘é¦–å…ˆæƒ³åˆ°ä½¿ç”¨pharæ¥æ„é€ ä¸€ä¸ªæ¶æ„æ–‡ä»¶ã€‚ä½†æˆ‘å¾ˆå¿«å‘ç°äº†é—®é¢˜ï¼šç”¨æˆ·è¾“å…¥çš„å†…å®¹ä¼šå…ˆæ ¡éªŒæ˜¯å¦æ»¡è¶³Lessæˆ–CSSçš„æ ¼å¼ã€‚å¦‚æœæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªpharæ ¼å¼çš„æ–‡ä»¶ï¼Œå°†ä¼šç›´æ¥å¯¼è‡´ä¿å­˜å‡ºé”™ï¼Œæ— æ³•æ­£å¸¸å†™å…¥æ–‡ä»¶ã€‚

[0x05 @importçš„å¦™ç”¨](#0x05-import)
-------------------------------

è¿™ä¸ªé—®é¢˜æˆ‘æƒ³äº†å¾ˆä¹…ä¹Ÿæ²¡æœ‰è§£å†³ï¼Œå°±åœ¨å³å°†æ”¾å¼ƒä¹‹æ—¶ï¼Œæˆ‘åœ¨é˜…è¯»less.phpä»£ç çš„æ—¶å€™å‘ç°å¦ä¸€ä¸ªæœ‰è¶£çš„æ–¹æ³•ï¼Œ`@import`ã€‚

åœ¨CSSæˆ–Lessä¸­ï¼Œ[`@import`](https://lesscss.org/features/#import-atrules-feature)ç”¨äºå¯¼å…¥å¤–éƒ¨CSSï¼Œç±»ä¼¼äºPHPä¸­çš„includeï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/908702b8-65a0-4b7c-9f14-d9207a5c4642.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/e36a829d-52a1-4013-a77a-7aef587b7cf5.png)

åœ¨Less.phpåº•å±‚ï¼Œ`@import`æ—¶æœ‰å¦‚ä¸‹åˆ¤æ–­é€»è¾‘ï¼š

*   å¦‚æœå‘ç°åŒ…å«çš„æ–‡ä»¶æ˜¯lessï¼Œåˆ™å¯¹å…¶è¿›è¡Œç¼–è¯‘è§£æï¼Œå¹¶å°†ç»“æœè¾“å‡ºåœ¨å½“å‰æ–‡ä»¶ä¸­
*   å¦‚æœå‘ç°åŒ…å«çš„æ–‡ä»¶æ˜¯cssï¼Œåˆ™ä¸å¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œç›´æ¥å°†`@import`è¿™ä¸ªè¯­å¥è¾“å‡ºåœ¨é¡µé¢æœ€å‰é¢

è¿™å°±æ¯”è¾ƒæœ‰è¶£äº†ï¼Œç¬¬äºŒç§æƒ…å†µå±…ç„¶å¯ä»¥â€œæ§åˆ¶â€æ–‡ä»¶å¤´ï¼Œè™½ç„¶å¯æ§çš„å†…å®¹åªæ˜¯ä¸€ä¸ª`@import`è¯­å¥ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥å°†å¯æ§å†…å®¹å˜æˆä»»æ„å†…å®¹å‘¢ï¼Ÿ

åœ¨è§£æ`@import`è¯­å¥çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€æ®µifè¯­å¥ï¼š

`if ( $this->options['inline'] ) {
    // todo needs to reference css file not import
    //$contents = new Less_Tree_Anonymous($this->root, 0, array('filename'=>$this->importedFilename), true );

    Less_Parser::AddParsedFile( $full_path );
    $contents = new Less_Tree_Anonymous( file_get_contents( $full_path ), 0, array(), true );

    if ( $this->features ) {
        return new Less_Tree_Media( array( $contents ), $this->features->value );
    }

    return array( $contents );
}` 

å½“`$this->options['inline']`ä¸º`true`æ—¶è¿›å…¥ifè¯­å¥ï¼Œå¹¶ä½¿ç”¨`file_get_contents`è¯»å–æ­¤æ—¶çš„URLï¼Œç›´æ¥ä½œä¸ºç»“æœè¿”å›ã€‚è€Œä¼—æ‰€å‘¨çŸ¥çš„æ˜¯ï¼Œ`file_get_contents`æ˜¯æ”¯æŒ`data:`åè®®çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`data:`åè®®æ¥æ§åˆ¶è¯»å–çš„æ–‡ä»¶å†…å®¹ã€‚

è®©`$this->options['inline']`ä¸º`true`çš„æ¡ä»¶ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘åœ¨[æ–‡æ¡£](https://lesscss.org/features/#import-atrules-feature-inline)ä¸­æ‰¾åˆ°äº†ç›¸å…³è¯´æ˜ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/e32b8723-723a-4c8e-a25e-49e1a20c5704.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/ac3aee71-7e7c-4d6f-9a92-693fe05194e1.png)

åœ¨`@import`è¯­å¥åé¢æŒ‡å®š`inline`é€‰é¡¹å³å¯ã€‚æ‰€ä»¥ï¼Œæˆ‘ä½¿ç”¨ä¸‹é¢è¿™æ®µCSSæ¥æµ‹è¯•ï¼š

`.test  {
  width:  1337px;
}

@import  (inline)  'data:,testtest';` 

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/8ace2644-001a-4e81-bc19-10eff13b2efa.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/0375938e-7413-4596-8107-aca5ccae46a6.png)

å“ˆï¼ŒæˆåŠŸåœ°å°†`testtest`è¿™ä¸²å­—ç¬¦ä¸²è¾“å‡ºåœ¨äº†CSSæ–‡ä»¶çš„æœ€å¼€å¤´ã€‚

é‚£ä¹ˆï¼Œæ•´ä¸ªåˆ©ç”¨é“¾å°±å¯ä»¥ä¸²èµ·æ¥äº†ï¼š**é€šè¿‡`@import (inline)`å’Œ`data:`åè®®çš„æ–¹å¼å¯ä»¥å‘assets/forum.cssæ–‡ä»¶çš„å¼€å¤´å†™å…¥ä»»æ„å­—ç¬¦ï¼Œå†é€šè¿‡`data-uri('phar://...')`çš„æ–¹å¼åŒ…å«è¿™ä¸ªæ–‡ä»¶ï¼Œè§¦å‘ååºåˆ—åŒ–æ¼æ´ï¼Œæœ€åæ‰§è¡Œä»»æ„å‘½ä»¤ã€‚** 

[0x06 æ¼æ´åˆ©ç”¨æˆåŠŸ](#0x06)
--------------------

å› ä¸ºå¯æ§æ–‡ä»¶å¤´ï¼Œæˆ‘é€‰æ‹©ç›´æ¥ä½¿ç”¨phpggcæ¥ç”Ÿæˆtaræ ¼å¼åŒ…ï¼š

`php phpggc -p tar -b Monolog/RCE6 system "id>/path/to/success.txt"` 

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/7c739f62-384f-4c83-8a63-8f2479ebf830.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/0cb44367-7ab7-4b95-ae66-d9f7ae56e95d.png)

ç„¶åæ„é€ æˆ`@import`çš„Payloadï¼Œåœ¨åå°ä¿®æ”¹ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/3d1e0822-850c-40af-9628-4569af8fc2ff.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/caa759c0-b713-43b3-9503-88b649e5c019.png)

æ­¤æ—¶è®¿é—®forum.csså³å¯å‘ç°æ–‡ä»¶å¤´å·²ç»è¢«æ§åˆ¶ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/545df3a4-1f72-4d85-914a-83e3b2eef1c4.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/e89c60f6-2f07-416a-a7ae-c9a8dbbabd9c.png)

æˆ‘ä»¬å†ä¿®æ”¹è‡ªå®šä¹‰CSSï¼Œä½¿ç”¨pharåè®®åŒ…å«è¿™ä¸ªæ–‡ä»¶ï¼ˆå¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/32ee056d-18a7-4085-b91b-a42c0215071f.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/5223ac92-2705-491d-b95b-9d4b2e07522f.png)

æˆåŠŸè§¦å‘ååºåˆ—åŒ–ï¼Œæ‰§è¡Œå‘½ä»¤`id`å†™å…¥webç›®å½•ï¼Œå®ŒæˆRCEï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/03e7fde2-0b4a-4757-ae43-4ce5605ff08f.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/d67da577-9d87-4c81-9982-72d6f78ca15f.png)

[0x07 æ€»ç»“](#0x07)
----------------

è¿™æ¬¡æ¼æ´æŒ–æ˜å¼€å§‹äºä¸€æ¬¡å¯¹Flarumåå°çš„æµ‹è¯•ï¼Œé€šè¿‡é˜…è¯»Flarumä¸less.phpçš„ä»£ç ï¼Œæ‰¾åˆ°less.phpçš„ä¸¤ä¸ªæœ‰è¶£çš„å‡½æ•°`data-uri`å’Œ`@import`ï¼Œæœ€åé€šè¿‡Pharååºåˆ—åŒ–æ‰§è¡Œä»»æ„å‘½ä»¤ã€‚

æ•´ä¸ªæµ‹è¯•è¿‡ç¨‹å…‹æœäº†ä¸å°‘å›°éš¾ï¼Œä¹Ÿæœ‰ä¸€äº›è¿æ°”ï¼Œè¿æ°”å¥½çš„ç‚¹åœ¨äºï¼Œç›®æ ‡PHPç‰ˆæœ¬æ˜¯7.4ï¼Œè€Œè¿™æ˜¯æœ€åä¸€ä¸ªæ”¯æŒä½¿ç”¨pharè¿›è¡Œåºåˆ—åŒ–çš„PHPç‰ˆæœ¬ï¼ˆPHPå·²å®‰å…¨ğŸ˜‚ï¼‰ã€‚ç”±äºéœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œæ‰€ä»¥æ¼æ´å¹¶æ— é€šç”¨å½±å“ï¼Œä½†ä»…ä»æœ‰è¶£ç¨‹åº¦æ¥çœ‹ï¼Œæ˜¯ä»Šå¹´æˆ‘æŒ–è¿‡çš„æœ€æœ‰è¶£çš„æ¼æ´ä¹‹ä¸€å§ã€‚

æœ€åï¼Œæ‰“å®Œæ”¶å·¥ï¼Œé€šçŸ¥ç¾¤å‹ï¼Œæœ‰å§‹æœ‰ç»ˆï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/58f9868e-1f51-408e-8088-5231476deffd.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/eb632dbf-d825-4ac2-b099-fe231d284729.png)

ä¸€çœ‹æ—¶é—´å·²4ç‚¹ï¼Œå¤©éƒ½å¿«äº®äº†ï¼ŒçœŸå¯è°“ï¼š

[![](https://github.com/D0n9/paper_archive/blob/main/paper/picture/2023/10/9b1e412a-8a6c-48dd-a7f4-9a2bc733f561.png?raw=true)
](https://www.leavesongs.com/media/attachment/2022/08/22/38ea0cca-b248-414e-95c0-818157c42e63.png)